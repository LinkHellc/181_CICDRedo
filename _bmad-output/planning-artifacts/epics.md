---
stepsCompleted: ['step-01-validate-prerequisites', 'step-02-design-epics', 'step-03-create-stories', 'step-04-final-validation']
inputDocuments: ['_bmad-output/planning-artifacts/prd.md']
workflowStatus: complete
---

# 181_CICDRedo - Epic Breakdown

## Overview

This document provides the complete epic and story breakdown for 181_CICDRedo, decomposing the requirements from the PRD into implementable stories.

### 变更记录

| 日期 | 变更内容 |
|------|---------|
| 2026-02-25 | Story 2.5/2.9/5.1/5.2 更新：移除 MATLAB Engine 依赖，改用纯 Python 实现 A2L 地址替换 |

> 详细变更内容请参见：`sprint-change-proposal-2026-02-25.md`

## Requirements Inventory

### Functional Requirements

**FR-001:** 用户可以创建新的项目配置，包含所有必需路径（Simulink工程、MATLAB代码路径、A2L路径、目标文件路径、IAR工程路径）
**FR-002:** 用户可以保存项目配置到本地文件系统（TOML格式）
**FR-003:** 用户可以加载已保存的项目配置
**FR-004:** 用户可以删除不再需要的项目配置
**FR-005:** 用户可以编辑现有项目配置的参数
**FR-006:** 用户可以选择预定义的工作流模板（完整流程、快速编译、跳过A2L、仅代码生成）
**FR-007:** 用户可以加载自定义工作流配置文件（JSON格式）
**FR-008:** 系统可以验证工作流配置的有效性（依赖检查、参数验证）
**FR-009:** 用户可以查看工作流的阶段列表和执行顺序
**FR-010:** 用户可以启动自动化构建流程
**FR-011:** 系统可以按顺序执行工作流中定义的阶段
**FR-012:** 系统可以启动MATLAB进程并执行代码生成
**FR-013:** 系统可以提取指定的代码文件（.c 和 .h），排除指定文件（Rte_TmsApp.h）
**FR-014:** 系统可以对Cal.c文件添加指定的内存区域定义代码（前缀和后缀）
**FR-015:** 系统可以移动代码文件到指定目录
**FR-016:** 系统可以调用IAR命令行进行编译
**FR-017:** 系统可以执行MATLAB命令更新A2L文件的变量地址
**FR-018:** 系统可以替换A2L文件的XCP头文件内容
**FR-019:** 系统可以创建带时间戳的目标文件夹
**FR-020:** 系统可以将HEX和A2L文件移动到目标文件夹
**FR-021:** 系统可以按照配置的时间戳格式命名所有生成文件
**FR-022:** 用户可以实时查看构建进度（当前阶段、整体进度百分比）
**FR-023:** 用户可以实时查看构建日志输出
**FR-024:** 系统可以捕获并显示外部进程（MATLAB、IAR）的输出
**FR-025:** 系统可以显示每个阶段的执行状态（等待中、进行中、已完成、失败）
**FR-026:** 系统可以记录每个阶段开始和结束的时间戳
**FR-027:** 系统可以在构建失败时显示清晰的错误信息
**FR-028:** 系统可以识别失败发生的具体阶段
**FR-029:** 系统可以提供可能的失败原因和建议操作
**FR-030:** 系统可以记录详细的错误日志到本地文件
**FR-031:** 系统可以在外部进程非正常退出时检测并报告
**FR-032:** 系统可以在启动时检测MATLAB是否已安装
**FR-033:** 系统可以在启动时检测IAR是否已安装
**FR-034:** 系统可以验证MATLAB版本是否符合最低要求（R2020a+）
**FR-035:** 系统可以验证IAR版本是否符合要求
**FR-036:** 系统可以在环境不满足要求时显示清晰的提示信息
**FR-037:** 系统可以检查配置目录的读写权限
**FR-038:** 系统可以在文件操作前清空目标目录
**FR-039:** 系统可以验证文件操作的成功与否
**FR-040:** 系统可以记录所有文件操作的日志
**FR-041:** 系统可以按配置的命名规范组织生成文件
**FR-042:** 系统可以检测MATLAB进程是否已存在并决定启动策略（Phase 2/3）
**FR-043:** 系统可以在构建完成后正确关闭MATLAB进程（Phase 2/3）
**FR-044:** 用户可以启用或禁用工作流中的特定阶段（Phase 2）
**FR-045:** 系统在执行时跳过被禁用的阶段（Phase 2）
**FR-046:** 用户可以取消正在执行的构建（Phase 2）
**FR-047:** 系统可以自动检测常见的MATLAB和IAR安装路径（Phase 2）
**FR-048:** 系统可以在首次运行时启动配置向导（Phase 2）
**FR-049:** 构建完成后系统可以显示完成通知（窗口闪烁或系统通知）（Phase 2）
**FR-050:** 用户可以在构建过程中最小化窗口到系统托盘（Phase 2）
**FR-051:** 日志窗口可以高亮显示包含ERROR、WARNING关键词的行（Phase 2）
**FR-052:** 用户可以搜索和过滤日志内容（Phase 2）
**FR-053:** 系统可以在错误修复后重新执行失败的构建（Phase 2）
**FR-054:** 系统可以保存失败的构建配置以便后续调试（Phase 2）
**FR-055:** 系统在清空目录前可以提示用户确认
**FR-056:** 系统可以备份目标目录中现有文件（Phase 2）
**FR-057:** 用户可以手动触发环境检测（Phase 2/3）
**FR-058:** 系统可以生成环境检测报告供技术支持使用（Phase 2/3）

### NonFunctional Requirements

**NFR-P001:** 完整构建流程在 20 分钟内完成（目标 15-20 分钟）
**NFR-P002:** 工具启动时间在 3 秒内
**NFR-P003:** UI 响应时间在 500ms 内（按钮点击、配置加载）
**NFR-P004:** 构建进度每秒至少更新一次
**NFR-P005:** 日志输出延迟不超过 1 秒
**NFR-R001:** 系统成功率达到 ≥ 98%（100 次运行最多 2 次失败）
**NFR-R002:** 系统在 MATLAB/IAR 版本兼容的情况下不崩溃
**NFR-R003:** 所有错误都有清晰的错误消息和恢复建议
**NFR-R004:** 外部进程异常退出时系统能正确检测并报告
**NFR-R005:** 配置文件损坏时系统能优雅降级或提示用户
**NFR-R006:** 文件操作失败时系统不丢失用户数据
**NFR-I001:** 系统兼容 MATLAB R2020a 及以上版本
**NFR-I002:** MATLAB Engine API 调用失败时系统能检测并报告
**NFR-I003:** MATLAB 进程占用内存不超过 2GB
**NFR-I004:** 系统兼容 IAR Embedded Workbench for ARM 9.x
**NFR-I005:** IAR 编译输出能被正确解析和显示
**NFR-I006:** 系统能处理路径长度超过 260 字符（Windows 长路径）
**NFR-I007:** 文件操作支持 UNC 路径（网络驱动器）
**NFR-U001:** 新用户能在 30 分钟内完成首次构建
**NFR-U002:** 错误信息包含可操作的建议
**NFR-U003:** 日志中错误行能被快速定位（高亮显示）
**NFR-M001:** 系统生成详细的日志文件用于故障排查
**NFR-M002:** 系统版本信息可在 UI 中查看
**NFR-M003:** 系统能生成环境检测报告

### Additional Requirements

由于没有 Architecture 和 UX Design 文档，额外需求将基于 PRD 中的技术决策提取：

**技术栈要求：**
- 开发语言：Python 3.10+（64位）
- UI 框架：PyQt6
- 打包方式：PyInstaller 打包成单文件 exe
- 配置格式：TOML（项目配置）、JSON（工作流配置）

**系统集成要求：**
- MATLAB Engine API for Python
- IAR 命令行接口 (iarbuild.exe)
- 用户环境必须预装 MATLAB R2020a+ 和 IAR Embedded Workbench for ARM 9.x

**环境要求：**
- 目标操作系统：Windows 10、11（64位）
- 完全离线运行，无网络依赖
- 配置存储位置：%APPDATA%/MBD_CICDKits/

### FR Coverage Map

| FR | Epic | 描述 |
|----|------|------|
| FR-001 至 FR-005 | Epic 1 | 项目配置管理 |
| FR-047 | Epic 1 | 自动路径检测 |
| FR-006 至 FR-021 | Epic 2 | 工作流执行 |
| FR-042 至 FR-046 | Epic 2 | 高级工作流功能（Phase 2） |
| FR-022 至 FR-026 | Epic 3 | 构建监控与反馈 |
| FR-049 至 FR-052 | Epic 3 | 通知和日志增强（Phase 2） |
| FR-027 至 FR-031 | Epic 4 | 错误处理与诊断 |
| FR-053, FR-054 | Epic 4 | 错误恢复（Phase 2） |
| FR-032 至 FR-041 | Epic 5 | 环境验证与文件管理 |
| FR-055 至 FR-058 | Epic 5 | 文件管理增强（Phase 2） |

## Epic List

### Epic 1: 项目配置管理

用户可以配置和管理项目参数，快速开始构建。

**用户成果：** 用户能够创建、保存、加载和编辑项目配置，系统自动检测常见安装路径。

**FRs covered:** FR-001, FR-002, FR-003, FR-004, FR-005, FR-047 (Phase 2)

### Epic 2: 工作流执行

用户可以定义并执行自动化构建流程，将 60 分钟手动工作自动化为 15 分钟。

**用户成果：** 用户可以选择工作流模板并一键启动自动化构建，系统执行 5 阶段流程（MATLAB→文件处理→IAR→A2L→文件归纳）

**FRs covered:** FR-006, FR-007, FR-008, FR-009, FR-010, FR-011, FR-012, FR-013, FR-014, FR-015, FR-016, FR-017, FR-018, FR-019, FR-020, FR-021, FR-042, FR-043, FR-044, FR-045, FR-046 (Phase 2)

### Epic 3: 构建监控与反馈

用户可以实时跟踪构建进度并获得清晰的完成通知。

**用户成果：** 用户可以实时查看构建进度、日志输出和错误高亮，构建完成后收到通知。

**FRs covered:** FR-022, FR-023, FR-024, FR-025, FR-026, FR-049, FR-050, FR-051, FR-052 (Phase 2)

### Epic 4: 错误处理与诊断

当构建失败时，用户能快速定位问题并获得可操作的解决建议。

**用户成果：** 系统提供清晰的错误信息、失败阶段识别和可操作的修复建议。

**FRs covered:** FR-027, FR-028, FR-029, FR-030, FR-031, FR-053, FR-054 (Phase 2)

### Epic 5: 环境验证与文件管理

系统确保环境正确并安全地管理文件操作。

**用户成果：** 系统自动检测 MATLAB/IAR 环境，安全地管理文件操作（清空、备份、确认）

**FRs covered:** FR-032, FR-033, FR-034, FR-035, FR-036, FR-037, FR-038, FR-039, FR-040, FR-041, FR-055, FR-056, FR-057, FR-058 (Phase 2)

---

## Story Details

### Epic 1: 项目配置管理

用户可以配置和管理项目参数，快速开始构建。

#### Story 1.1: 创建新项目配置

作为嵌入式开发工程师，
我想要创建新的项目配置并输入所有必需路径，
以便为自动化构建做好准备。

**Acceptance Criteria:**

**Given** 用户启动应用程序
**When** 用户选择"新建项目"选项
**Then** 系统显示项目配置表单，包含以下输入字段：
  - Simulink 工程路径（必需）
  - MATLAB 代码路径（必需）
  - A2L 文件路径（必需）
  - 目标文件路径（必需）
  - IAR 工程路径（必需）
**And** 每个路径输入字段旁边提供浏览文件夹按钮
**And** 系统验证所有路径字段都已填写
**And** 用户可以保存配置或取消操作

---

#### Story 1.2: 保存项目配置到本地

作为嵌入式开发工程师，
我想要保存项目配置到本地文件系统，
以便下次使用时无需重新输入所有路径。

**Acceptance Criteria:**

**Given** 用户已填写完整的项目配置信息
**When** 用户点击"保存"按钮
**Then** 系统将配置保存为 TOML 格式文件到 `%APPDATA%/MBD_CICDKits/projects/` 目录
**And** 文件名使用用户输入的项目名称
**And** 系统显示保存成功提示
**And** 如果保存目录不存在，系统自动创建目录
**And** 如果文件已存在，系统提示用户是否覆盖

---

#### Story 1.3: 加载已保存的项目配置

作为嵌入式开发工程师，
我想要加载已保存的项目配置，
以便快速恢复工作状态。

**Acceptance Criteria:**

**Given** 应用程序已启动且存在已保存的项目配置
**When** 用户从项目列表中选择一个项目并点击"加载"
**Then** 系统读取对应的 TOML 配置文件
**And** 系统填充所有配置字段到界面
**And** 系统显示当前加载的项目名称
**And** 如果配置文件损坏或格式错误，系统显示友好的错误提示

---

#### Story 1.4: 编辑现有项目配置

作为嵌入式开发工程师，
我想要修改现有项目的配置参数，
以便适应项目路径或需求的变化。

**Acceptance Criteria:**

**Given** 用户已加载一个项目配置
**When** 用户修改任何路径字段并保存
**Then** 系统验证新路径的有效性（目录是否存在）
**And** 系统更新 TOML 配置文件
**And** 系统显示配置已更新的确认消息
**And** 用户可以继续使用新配置进行构建

---

#### Story 1.5: 删除项目配置

作为嵌入式开发工程师，
我想要删除不再需要的项目配置，
以便保持项目列表的整洁。

**Acceptance Criteria:**

**Given** 项目列表中存在至少一个项目配置
**When** 用户选择一个项目并点击"删除"按钮
**Then** 系统显示确认对话框要求用户确认删除操作
**When** 用户确认删除
**Then** 系统从文件系统删除对应的 TOML 文件
**And** 系统从项目列表中移除该项目
**And** 系统显示删除成功的提示

---

#### Story 1.6: 自动检测 MATLAB 和 IAR 安装路径

作为嵌入式开发工程师，
我想要系统自动检测 MATLAB 和 IAR 的常见安装路径，
以便减少手动配置的工作量。

**Acceptance Criteria:**

**Given** 用户正在创建新项目配置
**When** 系统启动或用户点击"自动检测"按钮
**Then** 系统扫描以下常见安装路径：
  - MATLAB: `C:\Program Files\MATLAB\*`, `C:\Program Files (x86)\MATLAB\*`
  - IAR: `C:\Program Files\IAR Systems\*`
**And** 系统在路径输入字段中自动填充检测到的路径
**And** 系统标注自动检测的路径（如使用特殊图标或颜色）
**And** 如果检测到多个版本，系统选择最新版本
**And** 如果未检测到安装，系统显示提示信息建议手动指定

---

### Epic 2: 工作流执行

用户可以定义并执行自动化构建流程，将 60 分钟手动工作自动化为 15 分钟。

#### Story 2.1: 选择预定义工作流模板

作为嵌入式开发工程师，
我想要从预定义的工作流模板中选择一个，
以便快速启动不同场景的构建任务。

**Acceptance Criteria:**

**Given** 用户已加载项目配置
**When** 用户打开工作流选择界面
**Then** 系统显示以下预定义模板：
  - 完整流程（包含所有 5 个阶段）
  - 快速编译（跳过 A2L 更新）
  - 跳过 A2L（仅代码生成和编译）
  - 仅代码生成（仅 MATLAB 阶段）
**And** 每个模板显示描述信息和预计执行时间
**And** 用户选择模板后，系统显示该模板的阶段列表和执行顺序
**And** 系统保存用户选择的工作流配置

---

#### Story 2.2: 加载自定义工作流配置

作为嵌入式开发工程师，
我想要加载自定义的工作流配置文件，
以便执行个性化的构建流程。

**Acceptance Criteria:**

**Given** 用户已创建自定义工作流配置 JSON 文件
**When** 用户选择"加载自定义工作流"选项
**Then** 系统显示文件选择对话框
**When** 用户选择一个 JSON 文件
**Then** 系统解析 JSON 文件内容
**And** 系统验证工作流配置的格式和结构
**And** 系统显示工作流的阶段列表
**And** 如果配置文件格式错误，系统显示具体的错误位置和建议

---

#### Story 2.3: 验证工作流配置有效性

作为嵌入式开发工程师，
我想要系统验证工作流配置的有效性，
以便在执行前发现配置错误。

**Acceptance Criteria:**

**Given** 用户已选择或加载工作流配置
**When** 用户点击"验证配置"按钮
**Then** 系统执行以下验证：
  - 检查阶段依赖关系是否满足
  - 检查必需参数是否已配置
  - 检查路径是否存在
**And** 系统显示验证结果（成功/失败）
**And** 如果验证失败，系统列出所有问题点
**And** 系统阻止无效配置的执行

---

#### Story 2.4: 启动自动化构建流程

作为嵌入式开发工程师，
我想要一键启动自动化构建流程，
以便系统按顺序执行所有配置的阶段。

**Acceptance Criteria:**

**Given** 用户已配置项目和选择工作流
**When** 用户点击"开始构建"按钮
**Then** 系统锁定配置界面防止修改
**And** 系统开始执行工作流的第一个阶段
**And** 系统更新 UI 显示当前执行状态
**And** 系统记录构建开始时间戳
**And** 系统启用"取消构建"按钮

---

#### Story 2.5: 执行 MATLAB 代码生成阶段

> ⚠️ **变更说明 (2026-02-25)：** 此功能改为预留接口，暂不实现。

作为嵌入式开发工程师，
我想要系统预留 MATLAB 代码生成接口，
以便未来需要时可以扩展此功能。

**Acceptance Criteria:**

**Given** 构建流程已启动且进入 MATLAB 代码生成阶段
**When** 系统执行代码生成
**Then** 系统返回成功状态（预留接口，暂不执行实际操作）
**And** 系统在日志中记录"MATLAB 代码生成阶段已跳过（预留接口）"
**And** 系统记录阶段开始和结束时间
**And** 系统继续执行下一阶段

---

#### Story 2.6: 提取并处理代码文件

作为嵌入式开发工程师，
我想要系统自动提取指定的代码文件并处理 Cal.c，
以便准备集成到 IAR 工程。

**Acceptance Criteria:**

**Given** MATLAB 代码生成阶段已成功完成
**When** 系统进入文件处理阶段
**Then** 系统从 `./20_Code` 目录提取所有 `.c` 和 `.h` 文件
**And** 系统排除 `Rte_TmsApp.h` 文件
**And** 系统在 `Cal.c` 文件头文件引用下方添加前缀代码：
  ```
  #define ASW_ATECH_START_SEC_CALIB
  #include "Xcp_MemMap.h"
  ```
**And** 系统在 `Cal.c` 文件末尾添加后缀代码：
  ```
  #define ASW_ATECH_STOP_SEC_CALIB
  #include "Xcp_MemMap.h"
  #ifdef __cplusplus
  }
  #endif
  ```
**And** 系统验证文件修改成功

---

#### Story 2.7: 移动代码文件到指定目录

作为嵌入式开发工程师，
我想要系统自动移动处理后的代码文件，
以便更新 IAR 工程的源代码。

**Acceptance Criteria:**

**Given** 代码文件已提取和处理
**When** 系统执行文件移动操作
**Then** 系统清空目标目录（MATLAB 代码路径）
**And** 系统移动所有代码文件到目标目录
**And** 系统验证每个文件移动操作的成功性
**And** 系统记录所有文件操作到日志
**And** 如果移动失败，系统报告具体文件和错误原因

---

#### Story 2.8: 调用 IAR 命令行编译

作为嵌入式开发工程师，
我想要系统自动调用 IAR 编译器，
以便生成 ELF 和 HEX 文件。

**Acceptance Criteria:**

**Given** 代码文件已成功移动到 IAR 工程目录
**When** 系统进入 IAR 编译阶段
**Then** 系统调用 `iarbuild.exe` 命令行工具
**And** 系统传递 IAR 工程路径和编译参数
**And** 系统捕获编译输出并实时显示
**And** 系统监控编译进程状态
**And** 系统验证生成的 `.elf` 文件存在
**And** 系统执行 `HexMerge.bat` 生成 HEX 文件
**And** 如果编译失败，系统解析错误输出并报告

---

#### Story 2.9: 更新 A2L 文件变量地址

> ⚠️ **变更说明 (2026-02-25)：** 改用纯 Python 实现，基于原有 MATLAB 脚本逻辑。移除 MATLAB Engine 依赖。

作为嵌入式开发工程师，
我想要系统自动更新 A2L 文件中的变量地址，
以便匹配新编译的 ELF 文件。

**Acceptance Criteria:**

**Given** IAR 编译成功生成 ELF 文件
**When** 系统进入 A2L 更新阶段
**Then** 系统使用 Python 解析 ELF 文件提取符号地址（使用 pyelftools）
**And** 系统解析 A2L 文件结构
**And** 系统更新 A2L 文件中的变量地址为 ELF 文件中的对应地址
**And** 系统验证 A2L 文件已更新
**And** 系统在日志中记录更新的变量数量
**And** 如果更新失败，系统报告错误并继续

**技术实现：**
- 使用 `pyelftools` 库解析 ELF 文件
- 基于原有 MATLAB 脚本逻辑实现 Python 版本
- 模块位置：`src/a2l/address_updater.py`

---

#### Story 2.10: 替换 A2L 文件 XCP 头文件内容

作为嵌入式开发工程师，
我想要系统自动替换 A2L 文件的 XCP 头文件内容，
以便使用标准化的 XCP 协议定义。

**Acceptance Criteria:**

**Given** A2L 文件变量地址已更新
**When** 系统执行 XCP 头文件替换
**Then** 系统读取 `奇瑞热管理XCP头文件.txt` 模板内容
**And** 系统在 A2L 文件中定位 XCP 头文件部分
**And** 系统替换头部内容为模板内容
**And** 系统保存更新后的 A2L 文件
**And** 系统将文件重命名为 `tmsAPP_upAdress[_年_月_日_时_分].a2l`
**And** 系统验证文件替换成功

---

#### Story 2.11: 创建时间戳目标文件夹

作为嵌入式开发工程师，
我想要系统自动创建带时间戳的目标文件夹，
以便组织每次构建的输出文件。

**Acceptance Criteria:**

**Given** 所有构建阶段已完成
**When** 系统进入文件归纳阶段
**Then** 系统生成时间戳格式：`_年_月_日_时_分`（如 `_2025_02_02_15_43`）
**And** 系统创建目标文件夹：`MBD_CICD_Obj[_时间戳]`
**And** 文件夹创建在配置的目标文件路径下
**And** 如果同名文件夹已存在，系统提示用户或添加后缀

---

#### Story 2.12: 移动 HEX 和 A2L 文件到目标文件夹

作为嵌入式开发工程师，
我想要系统自动归集最终输出文件，
以便快速找到构建产物。

**Acceptance Criteria:**

**Given** 目标时间戳文件夹已创建
**When** 系统执行文件归纳
**Then** 系统移动 HEX 文件到目标文件夹
**And** 系统移动 A2L 文件到目标文件夹
**And** 系统按配置的命名规范重命名文件（如添加时间戳）
**And** 系统验证所有文件移动成功
**And** 系统在日志中记录最终文件位置

---

#### Story 2.13: 检测并管理 MATLAB 进程状态

作为嵌入式开发工程师，
我想要系统能检测现有 MATLAB 进程并决定启动策略，
以便优化资源使用和避免冲突。

**Acceptance Criteria:**

**Given** 系统准备执行 MATLAB 相关操作
**When** 系统检测 MATLAB 进程状态
**Then** 系统检查是否已有 MATLAB 进程在运行
**And** 如果存在 MATLAB 进程：
  - 系统尝试连接到现有进程
  - 系统验证进程版本兼容性（R2020a+）
  - 系统复用现有进程执行命令
**And** 如果不存在或连接失败：
  - 系统启动新的 MATLAB 进程
  - 系统配置进程参数（内存限制、等待时间）
**And** 构建完成后，系统根据启动策略决定是否关闭 MATLAB 进程

---

#### Story 2.14: 启用/禁用工作流阶段

作为嵌入式开发工程师，
我想要启用或禁用工作流中的特定阶段，
以便灵活控制构建流程。

**Acceptance Criteria:**

**Given** 用户已加载工作流配置
**When** 用户在工作流配置界面调整阶段开关
**Then** 系统显示所有阶段的启用/禁用状态
**And** 用户可以切换任何阶段的启用状态
**And** 系统自动调整依赖阶段（如禁用某阶段，其后续阶段也禁用）
**And** 系统保存用户的阶段配置
**And** 执行时系统跳过禁用的阶段

---

#### Story 2.15: 取消正在执行的构建

作为嵌入式开发工程师，
我想要在构建过程中取消执行，
以便快速停止错误或不需要的构建。

**Acceptance Criteria:**

**Given** 构建流程正在执行中
**When** 用户点击"取消构建"按钮
**Then** 系统显示确认对话框
**When** 用户确认取消
**Then** 系统停止当前阶段的执行
**And** 系统尝试终止外部进程（MATLAB、IAR）
**And** 系统清理临时文件和进程
**And** 系统更新 UI 显示构建已取消状态
**And** 系统记录取消操作到日志

---

### Epic 3: 构建监控与反馈

用户可以实时跟踪构建进度并获得清晰的完成通知。

#### Story 3.1: 实时显示构建进度

作为嵌入式开发工程师，
我想要实时查看构建的当前阶段和整体进度百分比，
以便了解构建执行状态。

**Acceptance Criteria:**

**Given** 构建流程正在执行
**When** 系统执行各个阶段
**Then** 系统在 UI 显示当前执行阶段名称
**And** 系统显示整体进度百分比（基于已完成阶段数）
**And** 系统显示每个阶段的执行状态（等待中、进行中、已完成、失败）
**And** 系统每秒至少更新一次进度信息
**And** 进度显示使用可视化组件（如进度条、状态图标）

---

#### Story 3.2: 实时显示构建日志输出

作为嵌入式开发工程师，
我想要实时查看构建日志输出，
以便监控构建过程中的详细信息。

**Acceptance Criteria:**

**Given** 构建流程正在执行
**When** 外部进程（MATLAB、IAR）产生输出
**Then** 系统捕获所有进程输出
**And** 系统实时将输出追加到日志窗口
**And** 日志输出延迟不超过 1 秒
**And** 系统为每条日志添加时间戳
**And** 系统支持自动滚动到最新日志
**And** 日志窗口支持手动滚动查看历史

---

#### Story 3.3: 记录并显示阶段执行时间

作为嵌入式开发工程师，
我想要查看每个阶段的执行时间，
以便分析性能瓶颈。

**Acceptance Criteria:**

**Given** 构建流程正在执行
**When** 每个阶段开始和结束
**Then** 系统记录每个阶段的开始时间戳
**And** 系统记录每个阶段的结束时间戳
**And** 系统计算并显示每个阶段的执行时长
**And** 系统在日志窗口显示时间信息
**And** 构建完成后，系统显示所有阶段的时间汇总

---

#### Story 3.4: 构建完成通知

作为嵌入式开发工程师，
我想要在构建完成后收到清晰的通知，
以便及时处理其他任务。

**Acceptance Criteria:**

**Given** 构建流程已完成（成功或失败）
**When** 构建进入完成状态
**Then** 系统触发窗口闪烁效果
**And** 系统可选显示系统通知（如 Windows 通知中心）
**And** 通知内容包含：构建状态（成功/失败）、项目名称、完成时间
**And** 用户点击通知可聚焦到应用程序窗口
**And** 如果构建失败，通知包含失败阶段信息

---

#### Story 3.5: 最小化到系统托盘

作为嵌入式开发工程师，
我想要在构建过程中最小化窗口到系统托盘，
以便不干扰其他工作。

**Acceptance Criteria:**

**Given** 应用程序窗口已打开
**When** 用户点击最小化按钮
**Then** 系统将窗口最小化到系统托盘
**And** 系统在托盘图标显示构建状态（如：空闲、构建中、成功、失败）
**And** 用户可以双击托盘图标恢复窗口
**And** 系统在托盘图标显示工具提示（如：项目名 - 构建中 75%）
**And** 构建完成时，托盘图标闪烁提示

---

#### Story 3.6: 日志高亮显示错误和警告

作为嵌入式开发工程师，
我想要日志窗口高亮显示包含 ERROR 和 WARNING 的行，
以便快速识别问题。

**Acceptance Criteria:**

**Given** 日志窗口正在显示输出
**When** 日志内容包含 ERROR、WARNING 关键词
**Then** 系统使用红色高亮显示包含 ERROR 的行
**And** 系统使用黄色高亮显示包含 WARNING 的行
**And** 高亮颜色可通过配置文件自定义
**And** 系统支持区分大小写和不区分大小写匹配
**And** 用户可以点击高亮行跳转到原始位置

---

#### Story 3.7: 搜索和过滤日志内容

作为嵌入式开发工程师，
我想要在日志中搜索和过滤内容，
以便快速定位特定信息。

**Acceptance Criteria:**

**Given** 日志窗口包含大量日志内容
**When** 用户在搜索框输入关键词
**Then** 系统实时高亮匹配的日志行
**And** 系统显示匹配结果数量
**And** 用户可以导航到上一个/下一个匹配项
**And** 系统支持过滤仅显示特定级别的日志（如仅 ERROR）
**And** 系统支持正则表达式搜索

---

### Epic 4: 错误处理与诊断

当构建失败时，用户能快速定位问题并获得可操作的解决建议。

#### Story 4.1: 识别失败阶段

作为嵌入式开发工程师，
我想要系统明确指出构建失败的阶段，
以便快速定位问题范围。

**Acceptance Criteria:**

**Given** 构建流程执行中某个阶段失败
**When** 系统检测到阶段失败
**Then** 系统在 UI 明确标识失败的阶段名称
**And** 系统在阶段列表中将失败阶段标记为红色
**And** 系统在日志窗口突出显示失败的命令或操作
**And** 系统显示失败发生的时间点
**And** 系统阻止后续阶段执行

---

#### Story 4.2: 显示可操作的修复建议

作为嵌入式开发工程师，
我想要系统提供可能的失败原因和修复建议，
以便快速解决问题。

**Acceptance Criteria:**

**Given** 构建流程在某阶段失败
**When** 系统识别失败类型
**Then** 系统在错误面板显示：
  - 失败原因描述
  - 可能的修复建议（可操作步骤）
  - 相关的日志行（带行号）
**And** 系统针对常见错误提供预设建议：
  - MATLAB 未安装/版本不兼容
  - IAR 工程路径错误
  - 文件权限不足
  - 磁盘空间不足
**And** 用户可以点击建议项查看详细说明

---

#### Story 4.3: 记录详细错误日志到本地文件

作为嵌入式开发工程师，
我想要系统将所有错误信息记录到本地日志文件，
以便进行离线分析和故障排查。

**Acceptance Criteria:**

**Given** 构建流程发生错误
**When** 系统检测到任何错误
**Then** 系统将错误信息追加到日志文件
**And** 日志文件位置：`%APPDATA%/MBD_CICDKits/logs/`
**And** 日志文件命名：`error_[YYYYMMDD].log`
**And** 日志内容包含：
  - 错误时间戳
  - 错误阶段
  - 错误类型
  - 完整错误消息
  - 堆栈跟踪（如果可用）
**And** 日志文件自动轮转（单文件最大 10MB）

---

#### Story 4.4: 检测外部进程异常退出

作为嵌入式开发工程师，
我想要系统检测外部进程（MATLAB、IAR）的异常退出，
以便及时报告错误。

**Acceptance Criteria:**

**Given** 系统正在监控外部进程
**When** 外部进程非正常退出（退出码非 0）
**Then** 系统捕获进程退出码
**And** 系统记录进程输出缓冲区内容
**And** 系统显示进程异常退出的错误消息
**And** 系统将错误标记为"外部进程失败"
**And** 系统提供可能的退出原因（如：崩溃、内存不足）

---

#### Story 4.5: 保存失败的构建配置

作为嵌入式开发工程师，
我想要系统保存失败的构建配置，
以便后续调试和重试。

**Acceptance Criteria:**

**Given** 构建流程失败
**When** 构建失败时
**Then** 系统自动保存当前项目配置和工作流配置
**And** 系统将配置保存到临时目录：`%APPDATA%/MBD_CICDKits/failed_builds/`
**And** 文件命名：`failed_[项目名]_[时间戳].json`
**And** 配置文件包含：
  - 项目配置
  - 工作流配置
  - 失败阶段
  - 失败时间
  - 错误摘要
**And** 用户可以从失败配置列表恢复并重新构建

---

#### Story 4.6: 重新执行失败的构建

作为嵌入式开发工程师，
我想要在修复错误后重新执行失败的构建，
以便继续完成构建任务。

**Acceptance Criteria:**

**Given** 用户已修复导致构建失败的问题
**When** 用户从失败配置列表选择一个配置并点击"重试"
**Then** 系统加载失败时的配置
**And** 系统从失败阶段重新开始构建
**And** 系统跳过已成功完成的阶段
**And** 系统在日志中标记为"重试构建"
**And** 如果仍然失败，系统更新失败配置记录

---

### Epic 5: 环境验证与文件管理

系统确保环境正确并安全地管理文件操作。

#### Story 5.1: 启动时检测 MATLAB 安装

> ⚠️ **变更说明 (2026-02-25)：** 移除 MATLAB Engine API 检测。MATLAB 代码生成功能已改为预留接口。

作为嵌入式开发工程师，
我想要系统在启动时检测 MATLAB 是否已安装，
以便提前发现环境问题。

**Acceptance Criteria:**

**Given** 用户启动应用程序
**When** 应用程序初始化
**Then** 系统检查 MATLAB 安装路径
**And** 系统验证 MATLAB 可执行文件存在
**And** ~~系统检查 MATLAB Engine API for Python 是否可导入~~（已移除）
**And** 如果检测失败，系统显示友好的错误提示：
  - "未检测到 MATLAB 安装"
  - "请安装 MATLAB R2020a 或更高版本"
  - ~~"请确保 MATLAB Engine API for Python 已安装"~~（已移除）
**And** 系统记录检测结果到日志

**注意：** 由于 MATLAB 代码生成功能已改为预留接口，MATLAB 检测为可选功能。

---

#### Story 5.2: 验证 MATLAB 版本兼容性

> ⚠️ **变更说明 (2026-02-25)：** 移除 Engine API 版本检测。简化为仅检测 MATLAB 版本。

作为嵌入式开发工程师，
我想要系统验证 MATLAB 版本是否符合要求，
以确保兼容性。

**Acceptance Criteria:**

**Given** 系统已检测到 MATLAB 安装
**When** 系统执行版本验证
**Then** 系统读取 MATLAB 版本信息
**And** 系统比较版本号与最低要求（R2020a）
**And** ~~系统检查 Engine API 版本~~（已移除）
**And** 如果版本符合要求，系统显示版本信息
**And** 如果版本不符合要求，系统显示：
  - 当前检测到的版本
  - 最低要求的版本
  - 升级建议
**And** 系统可选阻止构建（基于用户配置）

**注意：** 由于 MATLAB 代码生成功能已改为预留接口，此检测为可选功能。

---

#### Story 5.3: 启动时检测 IAR 安装

作为嵌入式开发工程师，
我想要系统在启动时检测 IAR 是否已安装，
以便提前发现编译器问题。

**Acceptance Criteria:**

**Given** 用户启动应用程序
**When** 应用程序初始化
**Then** 系统检查 IAR 安装路径
**And** 系统验证 `iarbuild.exe` 可执行文件存在
**And** 系统检查 IAR 版本信息
**And** 如果检测失败，系统显示友好的错误提示：
  - "未检测到 IAR Embedded Workbench 安装"
  - "请安装 IAR Embedded Workbench for ARM 9.x"
**And** 系统记录检测结果到日志

---

#### Story 5.4: 清空前提示用户确认

作为嵌入式开发工程师，
我想要系统在清空目录前提示确认，
以防止意外数据丢失。

**Acceptance Criteria:**

**Given** 系统准备清空目标目录
**When** 系统检测到目标目录包含文件
**Then** 系统显示确认对话框
**And** 对话框内容包含：
  - 将要清空的目录路径
  - 目录中的文件数量
  - 警告提示
**And** 用户可以选择：
  - 确认清空并继续
  - 取消操作
**And** 系统记住用户选择（本次会话）

---

#### Story 5.5: 备份目标目录现有文件

作为嵌入式开发工程师，
我想要系统在清空前备份目标目录中的现有文件，
以便需要时可以恢复。

**Acceptance Criteria:**

**Given** 用户启用备份功能
**When** 系统准备清空目标目录
**Then** 系统创建备份目录：`[目标目录]/backup_[时间戳]/`
**And** 系统复制目标目录中所有文件到备份目录
**And** 系统验证备份操作成功
**And** 如果备份失败，系统显示警告并询问是否继续
**And** 系统记录备份位置到日志
**And** 系统支持自动清理旧备份（保留最近 N 个）

---

#### Story 5.6: 验证文件操作成功

作为嵌入式开发工程师，
我想要系统验证所有文件操作的成功性，
以确保数据完整性。

**Acceptance Criteria:**

**Given** 系统执行任何文件操作（移动、复制、删除）
**When** 文件操作执行完成
**Then** 系统验证操作结果：
  - 文件是否存在（移动/复制）
  - 文件大小是否正确
  - 文件是否可读
**And** 如果验证失败，系统：
  - 记录详细错误信息
  - 尝试回滚操作（如果可能）
  - 显示用户友好的错误消息
**And** 系统在日志中记录验证结果

---

#### Story 5.7: 检查配置目录读写权限

作为嵌入式开发工程师，
我想要系统检查配置目录的读写权限，
以防止权限不足导致的功能异常。

**Acceptance Criteria:**

**Given** 系统启动或用户配置路径
**When** 系统执行权限检查
**Then** 系统验证配置目录存在
**And** 系统验证目录可写
**And** 系统尝试创建测试文件
**And** 系统删除测试文件
**And** 如果权限检查失败，系统显示：
  - 权限不足的具体路径
  - 建议的解决方案（以管理员身份运行、更改目录）
**And** 系统记录检查结果到日志

---

#### Story 5.8: 按命名规范组织生成文件

作为嵌入式开发工程师，
我想要系统按照配置的命名规范组织所有生成文件，
以便文件命名的一致性和可追溯性。

**Acceptance Criteria:**

**Given** 系统生成任何输出文件
**When** 系统创建或重命名文件
**Then** 系统应用命名规范：
  - 时间戳格式：`_年_月_日_时_分`
  - A2L 文件：`tmsAPP[_时间戳].a2l` → `tmsAPP_upAdress[_时间戳].a2l`
  - HEX 文件：`VIU_Chery_E0Y_FL1_R_CYT4BFV3_AB_[时间戳：_YYYYMMDD_V99_HH_MM].hex`
  - 目标文件夹：`MBD_CICD_Obj_[_时间戳]`
**And** 系统验证文件名不包含非法字符
**And** 系统处理文件名冲突（添加后缀）
**And** 系统记录所有文件命名操作到日志

---

#### Story 5.9: 手动触发环境检测

作为嵌入式开发工程师，
我想要随时手动触发环境检测，
以验证当前环境状态。

**Acceptance Criteria:**

**Given** 应用程序已启动
**When** 用户点击"环境检测"按钮
**Then** 系统执行完整的环境检测：
  - MATLAB 安装和版本
  - IAR 安装和版本
  - MATLAB Engine API
  - 目录权限
  - 磁盘空间
**And** 系统显示检测结果摘要
**And** 系统标记检测项为：通过/失败/警告
**And** 用户可以点击任何检测项查看详细信息

---

#### Story 5.10: 生成环境检测报告

作为嵌入式开发工程师或技术支持，
我想要生成环境检测报告，
以便用于技术支持和故障排查。

**Acceptance Criteria:**

**Given** 用户完成环境检测或系统自动检测
**When** 用户点击"生成报告"按钮
**Then** 系统生成环境检测报告文件
**And** 报告格式：文本或 Markdown
**And** 报告内容包含：
  - 系统信息（操作系统版本、架构）
  - MATLAB 信息（安装路径、版本、Engine API 版本）
  - IAR 信息（安装路径、版本）
  - 目录权限状态
  - 磁盘空间信息
  - 检测时间戳
  - 检测结果汇总
**And** 报告保存到用户指定位置或剪贴板
**And** 报告便于通过邮件或聊天工具分享

---

## Implementation Notes

### Story Sequencing
建议按以下顺序实施 Stories：

**Phase 1 (MVP):**
- Epic 1 全部（1.1 - 1.6）- 基础配置管理
- Epic 2 核心流程（2.1 - 2.12）- 基本 5 阶段自动化
- Epic 3 基础监控（3.1 - 3.3）- 进度和日志
- Epic 4 核心错误处理（4.1 - 4.4）- 错误识别和报告
- Epic 5 基础验证（5.1 - 5.3, 5.6 - 5.8）- 环境检测和文件操作

**Phase 2:**
- Epic 2 高级功能（2.13 - 2.15）- 进程管理和阶段控制
- Epic 3 增强功能（3.4 - 3.7）- 通知和日志增强
- Epic 4 恢复功能（4.5 - 4.6）- 失败重试
- Epic 5 增强功能（5.4 - 5.5, 5.9 - 5.10）- 备份和报告

### Technical Considerations
- 使用 PyQt6 实现所有 UI 组件
- MATLAB Engine API 用于与 MATLAB 交互
- subprocess 模块用于调用 IAR 命令行
- TOML 库用于配置文件解析
- 文件操作需要异常处理和日志记录
- 进程监控需要使用 psutil 或类似库
