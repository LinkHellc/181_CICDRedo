---
stepsCompleted: ['step-01-init', 'step-01b-continue', 'step-02-discovery', 'step-02-advanced-elicitation', 'step-03-success', 'step-04-journeys', 'step-05-domain', 'step-06-innovation', 'step-07-project-type', 'step-07-party-mode', 'step-08-scoping', 'step-09-functional', 'step-09-party-mode', 'step-10-nonfunctional', 'step-11-polish', 'step-12-complete']
inputDocuments: ['00_用户输入需求与材料/MBD_CICDKits需求.md', 'CLAUDE.md']
documentCounts:
  briefCount: 0
  researchCount: 0
  brainstormingCount: 0
  projectDocsCount: 1
workflowType: 'prd'
project_name: 181_CICDRedo
user_name: link
communication_language: Chinese
document_output_language: Chinese
date: 2026-02-02
classification:
  projectType: desktop_app
  domain: general
  complexity: medium
  projectContext: brownfield
  toolType: critical_dev_tool
  keyInsights:
    - 高可靠性要求 - 关键开发路径工具
    - 配置持久化和团队共享需求
    - 可操作的错误处理和日志系统
    - 用户体验要求高于简单辅助工具
    - 环境兼容性检查需要
---

# Product Requirements Document - MBD_CICDKits

**Author:** link
**Date:** 2026-02-02

---

## 文档状态

| 状态 | 说明 |
|------|------|
| 工作流步骤完成 | 所有 11 个步骤已完成 |
| 文档版本 | 1.0 (正式版) |
| 最后更新 | 2026-02-03 |

---

## 执行摘要

**MBD_CICDKits** 是一款面向嵌入式开发工程师的桌面自动化工具，专注于 Simulink 模型开发的 CI/CD 流程自动化。

### 产品定位

**目标用户：** 内部嵌入式开发工程师
**核心价值：** 将 60 分钟手动构建流程自动化为 15 分钟工具操作
**关键差异：** 可靠性优先（98%成功率）、可操作的错误诊断、团队协作友好

### 问题陈述

当前热管理 ECU 开发流程存在以下痛点：
- **低效率：** 手动执行 MATLAB 代码生成、文件处理、IAR 编译、A2L 处理，耗时 45-60 分钟
- **易出错：** 复杂的手动步骤（排除特定文件、编辑 Cal.c）容易遗漏或出错
- **难学习：** 新员工需要 2 天培训才能掌握完整流程
- **难排查：** 构建失败时难以定位问题

### 解决方案

MBD_CICDKits 提供自动化构建流程：
- 5 阶段完整自动化（配置 → MATLAB → IAR → A2L → 文件归纳）
- 可配置工作流支持不同使用场景
- 结构化日志和可操作的错误提示
- 团队配置共享通过 Git 实现

### 成功愿景

**3 个月：** 3-5 名工程师主动试用
**6 个月：** 60% 以上工程师日常使用
**12 个月：** 成为新员工入职培训内容，手动操作错误减少 90%

---

## 成功标准

### 用户成功

**"Aha!" 时刻场景：**

工程师打开工具，选择已保存的项目配置，点击"一键构建"，然后去喝咖啡。15分钟后收到通知："构建成功 ✅"。HEX 和 A2L 文件已经准备在目标文件夹。

**具体指标：**
- 每次构建时间：从 **60 分钟 → 15 分钟**
- 认知负担：无需记忆复杂流程，无需全程紧盯
- 成功体验：一次构建成功，错误信息清清楚楚

### 业务成功

| 时间线 | 目标 | 成功信号 |
|--------|------|----------|
| **3 个月** | MVP 验证 | 3-5 名工程师主动试用，有人主动分享给同事 |
| **6 个月** | 团队采用 | 60% 以上工程师日常使用，平均每次节省 30-40 分钟 |
| **12 个月** | 标准化工具 | 成为新员工入职培训内容，手动操作错误减少 90% |

**关键信号：** "这工具成功了" = 有人主动分享给同事说"试试这个工具"

### 技术成功

**可靠性指标：**
- 成功率：≥ **98%**（100 次运行最多 2 次失败）
- 错误信息：必须清晰显示"第 X 步出错 + 原因 + 解决建议"
- 可恢复性：90% 的错误可修复后从断点继续

**性能指标：**
- 完整构建时间：**15-20 分钟**
- 工具启动时间：**< 3 秒**
- 内存占用：**< 500MB**

**环境兼容性：**
- MATLAB R2020a+
- IAR Embedded Workbench for ARM 9.x
- Windows 10/11
- 启动时自动检测环境并报告兼容性问题

### 可衡量的结果

| 维度 | 指标 |
|------|------|
| **时间节省** | 每次构建节省 30-45 分钟 |
| **错误减少** | 手动操作错误减少 90% |
| **采用率** | 3 个月内 60% 工程师主动使用 |
| **配置复用** | 团队维护 3-5 个项目配置模板 |
| **新员工上手** | 30 分钟内完成首次构建 |

---

## 用户旅程

### 旅程 1：工程师小王 - 日常成功路径

**Opening Scene（开场）：**
周一上午9点，小王刚到工位，项目经理说"热管理策略v2.3需要今天下午验证"。小王心里想着又要开始那45-60分钟的重复构建流程...

**Rising Action（发展）：**
小王打开 MBD_CICDKits，工具显示上次的"热管理v2.2"配置。他只需选择新的Simulink模型文件，点击"开始构建"，然后去泡咖啡。

**Climax（高潮）：**
15分钟后，工具弹窗通知："✅ 构建成功！文件已保存到 MBD_CICD_Obj_2026_02_03_10_30\"

小王的感受："太爽了！刚才去泡咖啡的功夫就搞定了，而且文件命名规范、位置统一"

**Resolution（结局）：**
下午测试通过。小王在团队群里说："试试新工具，省了40分钟！"同事回复："真的？我明天也要用！"

### 旅程 2：新员工小李 - 首次使用学习

**Opening Scene（开场）：**
小李刚入职1周，导师说"你今天学习构建流程"。看着20多页的操作文档，小李心里很慌...

**Rising Action（发展）：**
导师打开工具，点击"加载配置"选择"热管理项目模板.json"，然后点"开始构建"。

工具界面实时显示每一步："提取文件... 排除Rte_TmsApp.h... 处理Cal.c..."

小李看着日志，第一次理解了整个流程："哦，原来要排除这个文件！原来Cal.c要加这样的前后缀！"

**Climax（高潮）：**
构建成功后，小李点开详细日志，看到每个步骤的具体操作。他说："原来整个流程是这样的，比看文档清楚多了"

**Resolution（结局）：**
导师回来惊讶："以前新人培训至少2天，你半天就会了"

### 旅程 3：技术支持老张 - 故障排查

**Opening Scene（开场）：**
周三下午，小王冲过来："张哥，工具又挂了！"

**Rising Action（发展）：**
老张打开工具，界面显示红色错误："❌ 阶段3/5：IAR编译失败"

点开详细日志：
```
[10:23:15] 阶段1/5：MATLAB代码生成... ✅
[10:23:45] 提取文件... ✅
...
[10:24:01] IAR编译失败 ❌

错误详情：
- 错误信息：Error[Li005]: no space in destination memory
- 可能原因：代码量超出Flash容量
- 建议操作：1.检查模型 2.优化代码 3.调整IAR配置
```

**Climax（高潮）：**
老张一看日志马上明白："小王，你是不是加了新的控制算法？Flash不够了"

从发现错误到给出诊断，只用了30秒

**Resolution（结局）：**
调整IAR配置后重新构建，5分钟解决问题。小王说："以前要搞半天，今天日志里直接写清楚了"

### 旅程需求总结

| 旅程 | 揭示的关键需求 |
|------|---------------|
| **小王（日常）** | 配置保存/快速加载、一键启动、进度显示、成功通知 |
| **小李（新手）** | 配置模板库、详细步骤日志、学习辅助 |
| **老张（技术支持）** | 结构化日志、可操作的错误信息、失败现场保留 |

---

## Desktop App 特定需求

### 平台支持

| 需求项 | 规格 |
|--------|------|
| **目标操作系统** | Windows 10、11 |
| **排除支持** | 不兼容 Win7 及更早版本 |
| **架构** | 64 位应用（x64） |
| **最低要求** | Windows 10 版本 21H2 或更高 |

**技术决策：**
- 使用 Python 3.10+（64位）作为开发语言
- UI 框架：PyQt6（原生 Windows 外观，支持实时进度、拖拽）
- 打包方式：PyInstaller 打包成单文件 exe

---

### 系统集成

**MATLAB 集成：**
- **依赖：** MATLAB R2020a+ 必须预装（用户环境）
- **启动方式：** 工具通过 MATLAB Engine API for Python 启动 MATLAB
- **进程策略：** 每次构建启动 → 运行 → 关闭（一天1-5次频率，保持进程不划算）
- **输出监控：** 实时捕获 MATLAB 输出和错误信息
- **版本检测：** 工具启动时检测 MATLAB 版本兼容性

**IAR 集成：**
- **依赖：** IAR Embedded Workbench for ARM 9.x 预装
- **调用方式：** 通过 IAR 命令行接口 (iarbuild.exe)
- **输出监控：** 解析 IAR 编译输出，提取错误/警告信息
- **路径检测：** 工具启动时验证 IAR 安装路径

**进程管理需求：**
- 启动外部进程前检查环境
- 实时捕获标准输出和标准错误
- 超时检测和进程终止能力
- 进程退出码检查

---

### 更新策略

**MVP 阶段：**
- ✅ 手动更新（复制新版本文件）
- ❌ 不实现自动更新功能
- ❌ 不实现版本检查功能

**打包分发：**
- PyInstaller 打包成单文件 exe
- 包含所有 Python 依赖（除 MATLAB Runtime）
- 用户仍需预装 MATLAB（无法打包 MATLAB 运行时）

---

### 离线能力

| 需求项 | 说明 |
|--------|------|
| **网络依赖** | 完全离线运行，无网络请求 |
| **配置存储** | 本地文件系统 |
| **配置格式** | TOML（支持注释，Python 3.11+ 内置） |

**文件存储结构：**
```
%APPDATA%/MBD_CICDKits/
├── workflows/               # 工作流配置
│   ├── 默认完整流程.workflow.json
│   ├── 快速编译.workflow.json
│   └── 自定义工作流.workflow.json
├── configs/                 # 项目配置
│   ├── 热管理项目.toml
│   └── 其他项目.toml
├── logs/                    # 运行日志
│   └── build_20260203_103015.log
└── settings.toml            # 工具全局设置
```

---

### 自定义工作流功能

**功能描述：**
- 拖拽式工作流编辑器
- 启用/禁用阶段，调整执行顺序
- 保存/加载工作流配置文件

**工作流模板：**
| 模板 | 说明 | 适用场景 |
|------|------|----------|
| 完整流程 | 所有5个阶段 | 首次完整构建 |
| 快速编译 | 仅 IAR 编译 | 代码已生成，只需编译 |
| 跳过A2L | 除A2L处理外的所有阶段 | A2L未变化 |
| 仅代码生成 | MATLAB + 文件处理 | 调试模型阶段 |

**技术实现：**
- 工作流引擎架构（可插拔阶段设计）
- 工作流配置文件格式：`.workflow.json`
- 执行前验证（依赖检查、参数验证）

---

### UI 界面设计

**主界面布局：**
```
┌─────────────────────────────────────────────┐
│  MBD_CICDKits                    🔧 ⚙️ ?   │
├─────────────────────────────────────────────┤
│  [选择项目配置 ▼]          [新建配置] [删除] │
│  [选择工作流 ▼]            [编辑工作流]     │
│                                              │
│  [🚀 开始构建]  [⏸ 暂停]  [📋 查看日志]   │
│                                              │
│  ┌─ 构建进度 ───────────────────────────┐  │
│  │ ▓▓▓▓▓▓▓░░░░░░░  60%                   │  │
│  │ ✅ 阶段1: MATLAB代码生成 (2分15秒)    │  │
│  │ 🔄 阶段3: IAR编译... (进行中)        │  │
│  └──────────────────────────────────────┘  │
│                                              │
│  ┌─ 实时日志 ───────────────────────────┐  │
│  │ [10:30:15] 开始构建...               │  │
│  │ [10:32:30] 代码生成完成 ✅           │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

**工作流编辑器：**
- 双栏布局（可用阶段 vs 当前工作流）
- 拖拽添加/重排阶段
- 启用/禁用开关
- 阶段配置编辑对话框

---

### 环境检测清单

工具启动时检查：
- ✅ MATLAB 版本和路径
- ✅ IAR 版本和路径
- ✅ Python 依赖包完整性
- ✅ 配置目录权限

---

## 项目范围与分阶段开发

### MVP 策略与理念

**MVP 方法：** 问题解决型 - 证明自动化流程可行且可靠
**资源需求：**
- 1 名 Python 开发工程师
- 1 名部分时间 QA
- 预计开发周期：2-3 个月

### MVP 功能集（第 1 阶段）

**支持的核心用户旅程：**
- ✅ 工程师小王的日常构建路径（完整5阶段流程）
- ⏸️ 小李的新手学习（简化配置，暂无向导）
- ⏸️ 老张的故障排查（基础日志，暂无高级诊断）

**必须具备的功能：**

| 功能 | 优先级 | 描述 |
|------|--------|------|
| **5 阶段完整流程** | P0 | 配置→MATLAB→IAR→A2L→归纳 |
| **基础 UI** | P0 | 配置输入、一键启动、实时日志显示 |
| **配置持久化** | P0 | 保存/加载项目配置（TOML 格式） |
| **环境检测** | P0 | 启动时检测 MATLAB/IAR 版本和路径 |
| **实时进度显示** | P1 | 阶段列表、进度条、实时日志滚动 |
| **基础错误处理** | P0 | 清晰的错误提示、失败原因说明 |
| **工作流配置文件** | P0 | 支持加载工作流配置（JSON 格式） |

**MVP 排除的功能：**
- ❌ 自定义工作流编辑器 UI
- ❌ 配置模板库
- ❌ 构建历史记录
- ❌ 断点续传
- ❌ 高级错误诊断和预警

### MVP 后功能（第 2 阶段 - Growth）

**目标：** 提升团队采用效率和用户体验

| 功能 | 描述 |
|------|------|
| **自定义工作流编辑器** | 拖拽式编辑、启用/禁用阶段、调整顺序 |
| **配置模板库** | 团队共享配置、快速应用模板 |
| **高级错误检测** | 环境兼容性检查、常见问题预警 |
| **使用统计** | 帮助识别优化机会 |
| **构建历史记录** | 查询过去的构建、复用配置 |

### 扩展功能（第 3 阶段 - Expansion）

**目标：** 成为团队开发流程的基础设施

| 功能 | 描述 |
|------|------|
| **断点续传** | 失败后从断点继续，而非从头开始 |
| **Git 集成** | 自动提交生成文件到指定分支 |
| **Web UI 支持** | 远程触发构建 |
| **构建分析和优化建议** | 基于数据提供流程优化建议 |
| **多项目管理和构建队列** | 支持多个项目并行管理 |

### 风险缓解策略

**技术风险：**
- **风险：** MATLAB/IAR 集成可能存在兼容性问题
- **缓解：** 早期验证环境检测机制，建立测试矩阵（不同 MATLAB/IAR 版本组合）

**市场风险：**
- **风险：** 用户可能不接受新工具，继续使用手动流程
- **缓解：** 早期让 3-5 名工程师试用并反馈，确保工具真正解决痛点

**资源风险：**
- **风险：** 开发资源不足，功能需要裁剪
- **缓解：** 明确 P0 功能，确保核心流程稳定；P1 功能可延后到第 2 阶段

---

## 功能需求

### 1. 项目配置管理

- **FR-001:** 用户可以创建新的项目配置，包含所有必需路径（Simulink工程、MATLAB代码路径、A2L路径、目标文件路径、IAR工程路径）
- **FR-002:** 用户可以保存项目配置到本地文件系统（TOML格式）
- **FR-003:** 用户可以加载已保存的项目配置
- **FR-004:** 用户可以删除不再需要的项目配置
- **FR-005:** 用户可以编辑现有项目配置的参数
- **FR-047:** 系统可以自动检测常见的MATLAB和IAR安装路径
- **FR-048:** 系统可以在首次运行时启动配置向导（Phase 2）

### 2. 工作流管理

- **FR-006:** 用户可以选择预定义的工作流模板（完整流程、快速编译、跳过A2L、仅代码生成）
- **FR-007:** 用户可以加载自定义工作流配置文件（JSON格式）
- **FR-008:** 系统可以验证工作流配置的有效性（依赖检查、参数验证）
- **FR-009:** 用户可以查看工作流的阶段列表和执行顺序
- **FR-044:** 用户可以启用或禁用工作流中的特定阶段
- **FR-045:** 系统在执行时跳过被禁用的阶段

### 3. 构建执行

- **FR-010:** 用户可以启动自动化构建流程
- **FR-011:** 系统可以按顺序执行工作流中定义的阶段
- **FR-012:** 系统可以启动MATLAB进程并执行代码生成
- **FR-042:** 系统可以检测MATLAB进程是否已存在并决定启动策略
- **FR-043:** 系统可以在构建完成后正确关闭MATLAB进程
- **FR-013:** 系统可以提取指定的代码文件（.c 和 .h），排除指定文件（Rte_TmsApp.h）
- **FR-014:** 系统可以对Cal.c文件添加指定的内存区域定义代码（前缀和后缀）
- **FR-015:** 系统可以移动代码文件到指定目录
- **FR-016:** 系统可以调用IAR命令行进行编译
- **FR-017:** 系统可以执行MATLAB命令更新A2L文件的变量地址
- **FR-018:** 系统可以替换A2L文件的XCP头文件内容
- **FR-019:** 系统可以创建带时间戳的目标文件夹
- **FR-020:** 系统可以将HEX和A2L文件移动到目标文件夹
- **FR-021:** 系统可以按照配置的时间戳格式命名所有生成文件
- **FR-046:** 用户可以取消正在执行的构建

### 4. 进度监控与日志

- **FR-022:** 用户可以实时查看构建进度（当前阶段、整体进度百分比）
- **FR-023:** 用户可以实时查看构建日志输出
- **FR-024:** 系统可以捕获并显示外部进程（MATLAB、IAR）的输出
- **FR-025:** 系统可以显示每个阶段的执行状态（等待中、进行中、已完成、失败）
- **FR-026:** 系统可以记录每个阶段开始和结束的时间戳
- **FR-049:** 构建完成后系统可以显示完成通知（窗口闪烁或系统通知）
- **FR-050:** 用户可以在构建过程中最小化窗口到系统托盘
- **FR-051:** 日志窗口可以高亮显示包含ERROR、WARNING关键词的行
- **FR-052:** 用户可以搜索和过滤日志内容

### 5. 错误处理与诊断

- **FR-027:** 系统可以在构建失败时显示清晰的错误信息
- **FR-028:** 系统可以识别失败发生的具体阶段
- **FR-029:** 系统可以提供可能的失败原因和建议操作
- **FR-030:** 系统可以记录详细的错误日志到本地文件
- **FR-031:** 系统可以在外部进程非正常退出时检测并报告
- **FR-053:** 系统可以在错误修复后重新执行失败的构建
- **FR-054:** 系统可以保存失败的构建配置以便后续调试

### 6. 环境检测与验证

- **FR-032:** 系统可以在启动时检测MATLAB是否已安装
- **FR-033:** 系统可以在启动时检测IAR是否已安装
- **FR-034:** 系统可以验证MATLAB版本是否符合最低要求（R2020a+）
- **FR-035:** 系统可以验证IAR版本是否符合要求
- **FR-036:** 系统可以在环境不满足要求时显示清晰的提示信息
- **FR-037:** 系统可以检查配置目录的读写权限
- **FR-057:** 用户可以手动触发环境检测（不只在启动时）
- **FR-058:** 系统可以生成环境检测报告供技术支持使用

### 7. 文件管理

- **FR-038:** 系统可以在文件操作前清空目标目录
- **FR-055:** 系统在清空目录前可以提示用户确认
- **FR-056:** 系统可以备份目标目录中现有文件（可选，Phase 2）
- **FR-039:** 系统可以验证文件操作的成功与否
- **FR-040:** 系统可以记录所有文件操作的日志
- **FR-041:** 系统可以按配置的命名规范组织生成文件

---

### 功能需求统计

| 能力区域 | 需求数量 |
|---------|---------|
| 项目配置管理 | 7 |
| 工作流管理 | 6 |
| 构建执行 | 14 |
| 进度监控与日志 | 9 |
| 错误处理与诊断 | 7 |
| 环境检测与验证 | 8 |
| 文件管理 | 6 |
| **总计** | **57** |

### MVP 优先级分类

**P0（必须有 - MVP）：**
- 所有核心构建执行需求（FR-010 到 FR-021）
- 基础配置管理（FR-001 到 FR-005）
- 基础进度监控（FR-022 到 FR-026）
- 错误处理（FR-027 到 FR-031）
- 环境检测（FR-032 到 FR-037）
- 文件管理基础（FR-038 到 FR-041）
- FR-055（清空前确认）

**P1（重要 - Phase 2）：**
- 工作流高级管理（FR-044, FR-045）
- 日志高亮和搜索（FR-051, FR-052）
- 完成通知（FR-049）
- 自动路径检测（FR-047）
- 取消构建（FR-046）

**P2（增强 - Phase 2/3）：**
- 配置向导（FR-048）
- 系统托盘（FR-050）
- 重试失败构建（FR-053, FR-054）
- 备份功能（FR-056）
- 手动环境检测（FR-057, FR-058）
- MATLAB进程管理（FR-042, FR-043）

---

## 非功能需求

### Performance（性能）

**构建时间：**
- **NFR-P001:** 完整构建流程在 20 分钟内完成（目标 15-20 分钟）
- **NFR-P002:** 工具启动时间在 3 秒内
- **NFR-P003:** UI 响应时间在 500ms 内（按钮点击、配置加载）

**进度更新：**
- **NFR-P004:** 构建进度每秒至少更新一次
- **NFR-P005:** 日志输出延迟不超过 1 秒

### Reliability（可靠性）

**可用性：**
- **NFR-R001:** 系统成功率达到 ≥ 98%（100 次运行最多 2 次失败）
- **NFR-R002:** 系统在 MATLAB/IAR 版本兼容的情况下不崩溃

**错误处理：**
- **NFR-R003:** 所有错误都有清晰的错误消息和恢复建议
- **NFR-R004:** 外部进程异常退出时系统能正确检测并报告

**数据完整性：**
- **NFR-R005:** 配置文件损坏时系统能优雅降级或提示用户
- **NFR-R006:** 文件操作失败时系统不丢失用户数据

### Integration（集成）

**MATLAB 集成：**
- **NFR-I001:** 系统兼容 MATLAB R2020a 及以上版本
- **NFR-I002:** MATLAB Engine API 调用失败时系统能检测并报告
- **NFR-I003:** MATLAB 进程占用内存不超过 2GB

**IAR 集成：**
- **NFR-I004:** 系统兼容 IAR Embedded Workbench for ARM 9.x
- **NFR-I005:** IAR 编译输出能被正确解析和显示

**文件系统：**
- **NFR-I006:** 系统能处理路径长度超过 260 字符（Windows 长路径）
- **NFR-I007:** 文件操作支持 UNC 路径（网络驱动器）

### Usability（可用性）

- **NFR-U001:** 新用户能在 30 分钟内完成首次构建
- **NFR-U002:** 错误信息包含可操作的建议
- **NFR-U003:** 日志中错误行能被快速定位（高亮显示）

### Maintainability（可维护性）

- **NFR-M001:** 系统生成详细的日志文件用于故障排查
- **NFR-M002:** 系统版本信息可在 UI 中查看
- **NFR-M003:** 系统能生成环境检测报告